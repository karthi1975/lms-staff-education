<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Teachers Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            color: #1f2937;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            color: #1f2937;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .search-filter {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
        }

        .search-filter input {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }

        .users-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            white-space: pre-wrap;
            font-family: monospace;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #667eea;
        }

        .stat-label {
            color: #6b7280;
            margin-top: 5px;
        }

        .breadcrumb {
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: #5a67d8;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #9ca3af;
        }

        .breadcrumb-current {
            color: #6b7280;
            font-weight: 500;
        }

        .user-type-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
        }

        .user-type-tab:hover {
            color: #667eea;
        }

        .user-type-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .user-form {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="/admin/lms-dashboard.html">üè† Home</a>
            <span class="breadcrumb-separator">‚Ä∫</span>
            <span class="breadcrumb-current">User Management</span>
        </nav>

        <header>
            <h1>üë• User Management</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="openAddUserModal()">‚ûï Add User</button>
                <a href="lms-dashboard.html" class="btn btn-secondary">‚Üê Back to Dashboard</a>
            </div>
        </header>

        <div id="alert" style="display: none;"></div>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeUsers">0</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedUsers">0</div>
                <div class="stat-label">Completed Module 1</div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter">
            <input type="text" id="searchInput" placeholder="üîç Search by name, email, or phone..." onkeyup="filterUsers()">
            <select id="statusFilter" onchange="filterUsers()" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>

        <!-- Users Table -->
        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>WhatsApp / Email</th>
                        <th>Module / Role</th>
                        <th>Progress</th>
                        <th>Last Active</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #999;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add User Modal (Dual Type: Admin + WhatsApp) -->
    <div id="addUserModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">üë• Add New User</div>

            <!-- User Type Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
                <button id="tabWhatsApp" class="user-type-tab active" onclick="switchUserType('whatsapp')">
                    üì± WhatsApp User
                </button>
                <button id="tabAdmin" class="user-type-tab" onclick="switchUserType('admin')">
                    üîê Admin User
                </button>
            </div>

            <!-- WhatsApp User Form -->
            <div id="formWhatsApp" class="user-form">
                <p style="margin-bottom: 20px; color: #6b7280; font-size: 14px;">
                    Creates a user account for WhatsApp-based learning. A 4-digit PIN will be generated for activation.
                </p>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="whatsappUserName" placeholder="e.g., Karthi Jeyabalan">
                </div>
                <div class="form-group">
                    <label>WhatsApp Number (E.164 format) *</label>
                    <input type="text" id="whatsappUserPhone" placeholder="+18016809129" pattern="\+[0-9]+" title="Must start with + followed by country code and number">
                    <small style="color: #6b7280; font-size: 12px;">
                        üìû Must include country code. Examples:<br>
                        ‚Ä¢ USA: +18016809129<br>
                        ‚Ä¢ Tanzania: +255123456789<br>
                        ‚Ä¢ Kenya: +254123456789
                    </small>
                </div>
                <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; color: #92400e;">
                    ‚ö†Ô∏è <strong>New PIN System:</strong> User will be assigned a 4-digit PIN. You must share this PIN with them offline (SMS/email). User messages WhatsApp bot and sends PIN to activate.
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="addWhatsAppUser()">Enroll User & Get PIN</button>
                </div>
            </div>

            <!-- Admin User Form -->
            <div id="formAdmin" class="user-form" style="display: none;">
                <p style="margin-bottom: 20px; color: #6b7280; font-size: 14px;">
                    Creates an admin account for managing the training system. No phone number required.
                </p>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="adminUserName" placeholder="e.g., Jane Doe">
                </div>
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" id="adminUserEmail" placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" id="adminUserPassword" placeholder="Must be 8+ characters">
                    <small style="color: #6b7280; font-size: 12px;">
                        üîí Must include uppercase, lowercase, and number (min 8 chars)
                    </small>
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="adminUserRole" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <option value="viewer">Viewer (Read-only)</option>
                        <option value="editor">Editor (Can modify content)</option>
                        <option value="admin" selected>Admin (Full access)</option>
                    </select>
                </div>
                <div style="background: #dbeafe; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; color: #1e3a8a;">
                    ‚ÑπÔ∏è <strong>Note:</strong> Admin users can log in to the admin dashboard. They do not receive WhatsApp messages.
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="addAdminUser()">Create Admin User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Delete User?</div>
            <p style="margin: 15px 0; color: #6b7280;">Are you sure you want to delete this user? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- PIN Display Modal (stays open until manually closed) -->
    <div id="pinModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: #10b981; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                <h2 style="margin: 0; font-size: 20px;">‚úÖ User Enrolled Successfully!</h2>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #065f46; margin-bottom: 10px; font-weight: 600;">USER DETAILS</div>
                    <div style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 5px;" id="pinUserName"></div>
                    <div style="font-size: 14px; color: #6b7280;" id="pinUserPhone"></div>
                </div>

                <div style="background: #fef3c7; border: 3px dashed #f59e0b; border-radius: 8px; padding: 30px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #92400e; margin-bottom: 10px; font-weight: 600;">üìå 4-DIGIT PIN</div>
                    <div style="font-size: 48px; font-weight: 700; color: #111827; letter-spacing: 8px; font-family: monospace;" id="pinValue"></div>
                    <div style="font-size: 12px; color: #92400e; margin-top: 10px;">
                        <span style="font-weight: 600;">‚è∞ Expires:</span> <span id="pinExpiry"></span>
                    </div>
                </div>

                <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 15px; text-align: left; margin-bottom: 20px; border-radius: 4px;">
                    <div style="font-weight: 600; color: #991b1b; margin-bottom: 8px;">‚ö†Ô∏è IMPORTANT INSTRUCTIONS:</div>
                    <ol style="color: #991b1b; font-size: 14px; margin: 0; padding-left: 20px; line-height: 1.6;">
                        <li><strong>Share this PIN</strong> with the user via SMS or email</li>
                        <li>User must message <strong>+1 806 515 7636</strong> on WhatsApp</li>
                        <li>Bot will prompt for PIN</li>
                        <li>User sends PIN to activate account</li>
                        <li><strong>PIN expires in 7 days</strong></li>
                    </ol>
                </div>

                <button class="btn btn-primary" onclick="copyPinToClipboard()" style="margin-right: 10px;">
                    üìã Copy PIN
                </button>
                <button class="btn btn-secondary" onclick="closePinModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        let allUsers = [];
        let userToDelete = null;

        // Load users on page load
        window.onload = loadUsers;

        async function loadUsers() {
            try {
                const authToken = localStorage.getItem('adminToken');

                if (!authToken) {
                    window.location.href = 'login.html';
                    return;
                }

                // Fetch both WhatsApp users and admin users in parallel
                const [whatsappResponse, adminResponse] = await Promise.all([
                    fetch('/api/admin/users', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch('/api/admin/admin-users', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);

                const whatsappResult = await whatsappResponse.json();
                const adminResult = await adminResponse.json();

                if (!whatsappResult.success || !adminResult.success) {
                    showAlert('Failed to load some users', 'error');
                }

                // Merge both user types, adding a type flag
                const whatsappUsers = (whatsappResult.data || []).map(u => ({ ...u, userType: 'whatsapp' }));
                const adminUsers = (adminResult.data || []).map(u => ({ ...u, userType: 'admin' }));

                allUsers = [...whatsappUsers, ...adminUsers];

                displayUsers(allUsers);
                updateStats();
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Error loading users', 'error');
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const isAdminUser = user.userType === 'admin';

                // Debug logging for User 9129
                if (user.id === 9 || user.name === 'User 9129') {
                    console.log('User 9129 Data:', {
                        is_active: user.is_active,
                        last_active_at: user.last_active_at,
                        daysSinceActive: user.last_active_at ?
                            (new Date() - new Date(user.last_active_at)) / (1000 * 60 * 60 * 24) : null
                    });
                }

                // Display fields based on user type
                const lastActive = (isAdminUser ? user.last_login_at : user.last_active_at)
                    ? new Date(isAdminUser ? user.last_login_at : user.last_active_at).toLocaleDateString()
                    : 'Never';

                // For admin users: show is_active status directly
                // For WhatsApp users: SIMPLIFIED - just check is_active (remove 7-day requirement)
                const isActive = isAdminUser
                    ? user.is_active
                    : user.is_active;

                const statusBadge = isActive
                    ? '<span class="badge badge-active">Active</span>'
                    : '<span class="badge badge-inactive">Inactive</span>';

                const progress = user.progress_percentage || 0;

                // WhatsApp field: show email for admin users, phone for WhatsApp users
                const whatsappField = isAdminUser
                    ? `<span style="color: #6b7280; font-size: 12px;">${user.email || 'N/A'}</span>`
                    : (user.whatsapp_id || 'N/A');

                // Module/Role field: show role for admin users, module for WhatsApp users
                const moduleField = isAdminUser
                    ? `<span class="badge" style="background: #dbeafe; color: #1e40af;">${user.role || 'N/A'}</span>`
                    : `Module ${user.current_module_id || 1}`;

                // Progress field: show dash for admin users
                const progressField = isAdminUser ? '-' : `${progress}%`;

                return `
                    <tr>
                        <td>${user.name || 'N/A'}</td>
                        <td>${whatsappField}</td>
                        <td>${moduleField}</td>
                        <td>${progressField}</td>
                        <td>${lastActive}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${!isAdminUser ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;"
                                onclick="viewUser(${user.id})">View</button>` : ''}
                            <button class="btn ${user.is_active ? 'btn-secondary' : 'btn-primary'}" style="padding: 6px 12px; font-size: 12px;"
                                onclick="${isAdminUser ? `toggleAdminStatus(${user.id}, ${user.is_active})` : `toggleWhatsAppStatus(${user.id}, ${user.is_active})`}">${user.is_active ? 'Deactivate' : 'Activate'}</button>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;"
                                onclick="openDeleteModal(${user.id}, '${user.name}', '${user.userType}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            document.getElementById('totalUsers').textContent = allUsers.length;

            // Count all users where is_active = true (both admin and WhatsApp)
            const activeCount = allUsers.filter(u => u.is_active).length;
            document.getElementById('activeUsers').textContent = activeCount;

            const completedCount = allUsers.filter(u => u.current_module_id > 1).length;
            document.getElementById('completedUsers').textContent = completedCount;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = allUsers.filter(user => {
                const matchesSearch = (user.name || '').toLowerCase().includes(searchTerm) ||
                    (user.whatsapp_id || '').toLowerCase().includes(searchTerm) ||
                    (user.email || '').toLowerCase().includes(searchTerm);

                if (!matchesSearch) return false;

                if (statusFilter === '') return true;

                // Simplified: just check is_active for all user types
                return (statusFilter === 'active' && user.is_active) ||
                       (statusFilter === 'inactive' && !user.is_active);
            });

            displayUsers(filtered);
        }

        function openAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.remove('active');
            // Clear WhatsApp form
            document.getElementById('whatsappUserName').value = '';
            document.getElementById('whatsappUserPhone').value = '';
            // Clear Admin form
            document.getElementById('adminUserName').value = '';
            document.getElementById('adminUserEmail').value = '';
            document.getElementById('adminUserPassword').value = '';
            document.getElementById('adminUserRole').value = 'admin';
            // Reset to WhatsApp tab
            switchUserType('whatsapp');
        }

        function switchUserType(type) {
            // Update tab buttons
            document.getElementById('tabWhatsApp').classList.toggle('active', type === 'whatsapp');
            document.getElementById('tabAdmin').classList.toggle('active', type === 'admin');

            // Show/hide forms
            document.getElementById('formWhatsApp').style.display = type === 'whatsapp' ? 'block' : 'none';
            document.getElementById('formAdmin').style.display = type === 'admin' ? 'block' : 'none';
        }

        async function addWhatsAppUser() {
            const name = document.getElementById('whatsappUserName').value.trim();
            const phone = document.getElementById('whatsappUserPhone').value.trim();

            if (!name || !phone) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            // Validate phone number format
            if (!phone.startsWith('+')) {
                showAlert('Phone number must start with + (e.g., +18016809129)', 'error');
                return;
            }

            try {
                const authToken = localStorage.getItem('adminToken');

                // Use the new PIN enrollment endpoint
                const response = await fetch('/api/admin/users/enroll', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        phoneNumber: phone
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Show PIN to admin in persistent modal
                    const pin = result.data.pin;
                    const expiresAt = new Date(result.data.expiresAt).toLocaleString();

                    // Close add user modal FIRST
                    closeAddUserModal();

                    // THEN show PIN modal (persistent - stays until manually closed)
                    showPinModal(name, phone, pin, expiresAt);

                    // Note: We don't reload users here to avoid interfering with PIN modal
                    // The modal will be manually closed by admin, then they can refresh if needed
                } else {
                    showAlert(result.error || 'Failed to enroll user', 'error');
                }
            } catch (error) {
                console.error('Error enrolling WhatsApp user:', error);
                showAlert('Error enrolling user: ' + error.message, 'error');
            }
        }

        async function addAdminUser() {
            const name = document.getElementById('adminUserName').value.trim();
            const email = document.getElementById('adminUserEmail').value.trim();
            const password = document.getElementById('adminUserPassword').value;
            const role = document.getElementById('adminUserRole').value;

            if (!name || !email || !password) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('Invalid email format', 'error');
                return;
            }

            // Validate password strength
            if (password.length < 8) {
                showAlert('Password must be at least 8 characters', 'error');
                return;
            }

            if (!/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/[0-9]/.test(password)) {
                showAlert('Password must include uppercase, lowercase, and number', 'error');
                return;
            }

            try {
                const authToken = localStorage.getItem('adminToken');

                const response = await fetch('/api/admin/admin-users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        email,
                        password,
                        role
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`‚úÖ Admin user created successfully!\n\nEmail: ${email}\nRole: ${role}`, 'success');
                    closeAddUserModal();
                    loadUsers(); // Reload to show new admin user
                } else {
                    showAlert(result.error || 'Failed to create admin user', 'error');
                }
            } catch (error) {
                console.error('Error creating admin user:', error);
                showAlert('Error creating admin user: ' + error.message, 'error');
            }
        }

        function openDeleteModal(userId, userName, userType) {
            userToDelete = { id: userId, type: userType };
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            userToDelete = null;
        }

        async function confirmDelete() {
            if (!userToDelete) return;

            try {
                const authToken = localStorage.getItem('adminToken');

                // Use different endpoints based on user type
                const endpoint = userToDelete.type === 'admin'
                    ? `/api/admin/admin-users/${userToDelete.id}`
                    : `/api/admin/users/${userToDelete.id}`;

                const response = await fetch(endpoint, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('User deleted successfully', 'success');
                    closeDeleteModal();
                    loadUsers();
                } else {
                    showAlert(result.error || 'Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('Error deleting user', 'error');
            }
        }

        async function toggleAdminStatus(userId, currentStatus) {
            try {
                const authToken = localStorage.getItem('adminToken');

                const response = await fetch(`/api/admin/admin-users/${userId}/toggle-status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const action = currentStatus ? 'deactivated' : 'activated';
                    showAlert(`‚úÖ Admin user ${action} successfully`, 'success');
                    loadUsers(); // Reload to show updated status
                } else {
                    showAlert(result.error || 'Failed to update user status', 'error');
                }
            } catch (error) {
                console.error('Error toggling admin status:', error);
                showAlert('Error updating user status: ' + error.message, 'error');
            }
        }

        async function toggleWhatsAppStatus(userId, currentStatus) {
            try {
                const authToken = localStorage.getItem('adminToken');

                const response = await fetch(`/api/admin/users/${userId}/toggle-status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        is_active: !currentStatus
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const action = currentStatus ? 'deactivated' : 'activated';
                    showAlert(`‚úÖ WhatsApp user ${action} successfully`, 'success');
                    loadUsers(); // Reload to show updated status
                } else {
                    showAlert(result.error || 'Failed to update user status', 'error');
                }
            } catch (error) {
                console.error('Error toggling WhatsApp status:', error);
                showAlert('Error updating user status: ' + error.message, 'error');
            }
        }

        function viewUser(userId) {
            window.location.href = `user-detail.html?id=${userId}`;
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // PIN Modal Functions
        function showPinModal(name, phone, pin, expiresAt) {
            document.getElementById('pinUserName').textContent = name;
            document.getElementById('pinUserPhone').textContent = phone;
            document.getElementById('pinValue').textContent = pin;
            document.getElementById('pinExpiry').textContent = expiresAt;
            document.getElementById('pinModal').classList.add('active');

            // Store PIN for copy function
            window.currentPin = pin;
        }

        function closePinModal() {
            document.getElementById('pinModal').classList.remove('active');
            window.currentPin = null;

            // Reload users after PIN modal is closed
            loadUsers();
        }

        function copyPinToClipboard() {
            if (window.currentPin) {
                navigator.clipboard.writeText(window.currentPin).then(() => {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ Copied!';
                    btn.style.background = '#10b981';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#667eea';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('PIN: ' + window.currentPin);
                });
            }
        }

        // Close modals on outside click
        document.getElementById('addUserModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddUserModal();
            }
        });

        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        document.getElementById('pinModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePinModal();
            }
        });

        // Cache buster - Updated 2025-10-16 - PIN enrollment system with persistent modal
        console.log('User Management v5 - PIN enrollment system active');
    </script>
</body>
</html>
