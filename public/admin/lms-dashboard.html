<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachers Training - Learning Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f6f9;
            color: #3a3a3a;
        }

        /* Moodle-style Top Navigation */
        .top-navbar {
            background: #fff;
            border-bottom: 3px solid #f98012;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .top-navbar-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .site-logo {
            font-size: 32px;
        }

        .site-title {
            font-size: 22px;
            font-weight: 600;
            color: #0f6cbf;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
        }

        .nav-tab {
            padding: 22px 20px;
            color: #3a3a3a;
            text-decoration: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: #f4f6f9;
            border-bottom-color: #0f6cbf;
        }

        .nav-tab.active {
            background: #f4f6f9;
            border-bottom-color: #f98012;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }

        .logout-link {
            color: #0f6cbf;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid #0f6cbf;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .logout-link:hover {
            background: #0f6cbf;
            color: white;
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .breadcrumb-trail {
            background: #fff;
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb-trail a {
            color: #0f6cbf;
            text-decoration: none;
            transition: all 0.2s;
        }

        .breadcrumb-trail a:hover {
            text-decoration: underline;
            color: #0c5aa1;
        }

        .breadcrumb-separator {
            color: #999;
        }

        .breadcrumb-current {
            color: #3a3a3a;
            font-weight: 500;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .info-box {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .info-box:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .info-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .info-box-title {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .info-box-icon {
            font-size: 28px;
        }

        .info-box-value {
            font-size: 36px;
            font-weight: 700;
            color: #0f6cbf;
            margin-bottom: 10px;
        }

        .info-box-footer {
            font-size: 12px;
            color: #999;
        }

        /* Content Sections */
        .content-section {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .section-header {
            background: linear-gradient(to bottom, #f9f9f9 0%, #ececec 100%);
            border-bottom: 1px solid #ddd;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #3a3a3a;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .btn-moodle {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: #3a3a3a;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-moodle:hover {
            background: #0f6cbf;
            color: white;
            border-color: #0f6cbf;
        }

        .btn-primary-moodle {
            background: #0f6cbf;
            color: white;
            border-color: #0f6cbf;
        }

        .btn-primary-moodle:hover {
            background: #0c5aa1;
            border-color: #0c5aa1;
        }

        .btn-danger {
            background: transparent;
            color: #ea4335;
            border: 1px solid #ea4335;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-danger:hover {
            background: #ea4335;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(234, 67, 53, 0.3);
        }

        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(234, 67, 53, 0.3);
        }

        /* Icon buttons - Material style */
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }

        .btn-icon:hover {
            background: rgba(0,0,0,0.04);
        }

        .btn-icon-danger:hover {
            background: rgba(234, 67, 53, 0.08);
            color: #ea4335;
        }

        .section-body {
            padding: 20px;
        }

        /* Table Styles */
        .moodle-table {
            width: 100%;
            border-collapse: collapse;
        }

        .moodle-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #3a3a3a;
            border-bottom: 2px solid #ddd;
        }

        .moodle-table td {
            padding: 12px;
            border-bottom: 1px solid #efefef;
            font-size: 14px;
        }

        .moodle-table tbody tr:hover {
            background: #f9f9f9;
        }

        /* Module Cards - Google Material Design */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 24px;
        }

        .module-card {
            background: #fff;
            border: none;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.06);
        }

        .module-card:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.08);
            transform: translateY(-4px);
        }

        .module-card-header {
            background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
            padding: 24px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .module-card-header::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .module-number {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .module-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .module-description {
            font-size: 14px;
            opacity: 0.95;
            line-height: 1.5;
        }

        .module-card-body {
            padding: 24px;
        }

        .module-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .module-stat {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .module-stat:hover {
            background: #e8f0fe;
            transform: scale(1.05);
        }

        .module-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a73e8;
        }

        .module-stat-label {
            font-size: 11px;
            color: #5f6368;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .module-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .module-actions button {
            flex: 1;
            min-width: 100px;
        }

        /* Badge Styles */
        .badge-moodle {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* Tab System */
        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs-list {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            padding: 12px 24px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #3a3a3a;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: #ebebeb;
        }

        .tab-button.active {
            background: #fff;
            color: #0f6cbf;
            border-bottom: 2px solid #fff;
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Progress Bars */
        .progress-bar-container {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #667eea, #764ba2);
            transition: width 0.3s;
        }

        /* User List */
        .user-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #efefef;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-item:hover {
            background: #f9f9f9;
        }

        .user-item-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .user-item-info {
            flex: 1;
        }

        .user-item-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .user-item-meta {
            font-size: 12px;
            color: #666;
        }

        .user-item-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
        }

        /* Search Bar */
        .search-bar {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            max-width: 400px;
            font-size: 14px;
        }

        .search-bar:focus {
            outline: none;
            border-color: #0f6cbf;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        /* Chat Modal */
        .chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .chat-modal.active {
            display: flex;
        }

        .chat-modal-content {
            background: white;
            width: 90%;
            max-width: 700px;
            height: 80vh;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .chat-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .chat-modal-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .chat-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .chat-msg {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
        }

        .chat-msg.user-msg {
            flex-direction: row-reverse;
        }

        .chat-msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #0f6cbf;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-msg.user-msg .chat-msg-avatar {
            background: #667eea;
        }

        .chat-msg-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .chat-msg.user-msg .chat-msg-bubble {
            background: #667eea;
            color: white;
        }

        .chat-msg-text {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Markdown styling for AI responses */
        .chat-msg-text h1, .chat-msg-text h2, .chat-msg-text h3 {
            margin-top: 12px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .chat-msg-text h1 {
            font-size: 18px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 4px;
        }

        .chat-msg-text h2 {
            font-size: 16px;
            color: #374151;
        }

        .chat-msg-text h3 {
            font-size: 15px;
            color: #4b5563;
        }

        .chat-msg-text strong {
            font-weight: 600;
            color: #1f2937;
        }

        .chat-msg-text em {
            font-style: italic;
            color: #4b5563;
        }

        .chat-msg-text ul, .chat-msg-text ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .chat-msg-text li {
            margin: 4px 0;
            line-height: 1.5;
        }

        .chat-msg-text p {
            margin: 8px 0;
        }

        .chat-msg-text code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: #dc2626;
        }

        .chat-msg-text pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .chat-msg-text pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        .chat-msg-text blockquote {
            border-left: 3px solid #667eea;
            padding-left: 12px;
            margin: 8px 0;
            color: #6b7280;
            font-style: italic;
        }

        .chat-msg-text a {
            color: #667eea;
            text-decoration: underline;
        }

        .chat-msg-text a:hover {
            color: #5568d3;
        }

        /* Numbered list styling */
        .chat-msg-text ol {
            counter-reset: item;
        }

        .chat-msg-text ol li {
            display: block;
        }

        .chat-msg-text ol li::before {
            content: counter(item) ". ";
            counter-increment: item;
            font-weight: 600;
            color: #667eea;
        }

        .chat-msg-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .chat-msg.user-msg .chat-msg-time {
            color: rgba(255,255,255,0.7);
        }

        .chat-sources {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 11px;
            color: #666;
        }

        .source-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #0f6cbf;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 4px;
            margin-top: 4px;
            font-size: 10px;
        }

        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            background: white;
            border-radius: 0 0 8px 8px;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-textarea {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
        }

        .chat-textarea:focus {
            outline: none;
            border-color: #0f6cbf;
        }

        .chat-send-btn {
            padding: 10px 20px;
            background: #0f6cbf;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            background: #0c5aa1;
        }

        .chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .typing-indicator-msg {
            display: flex;
            gap: 4px;
            padding: 10px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <div class="top-navbar">
        <div class="top-navbar-inner">
            <div class="logo-section">
                <div class="site-logo">üìö</div>
                <div class="site-title">Teachers Training LMS</div>
            </div>

            <div class="nav-tabs">
                <a href="#" class="nav-tab active" onclick="showTab('dashboard'); return false;">Dashboard</a>
                <a href="#" class="nav-tab" onclick="showTab('courses'); return false;">Courses</a>
                <a href="user-management.html" class="nav-tab">üë• Manage Users</a>
            </div>

            <div class="user-menu">
                <div class="user-avatar-circle" id="userAvatar">A</div>
                <span id="userName">Admin</span>
                <a href="#" class="logout-link" onclick="handleLogout(); return false;">Logout</a>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Breadcrumb -->
        <div class="breadcrumb-trail">
            <a href="lms-dashboard.html">üè† Home</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current" id="currentSection">Dashboard</span>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <!-- Stats -->
            <div class="dashboard-grid">
                <div class="info-box">
                    <div class="info-box-header">
                        <div class="info-box-title">Total Users</div>
                        <div class="info-box-icon">üë•</div>
                    </div>
                    <div class="info-box-value" id="totalUsers">0</div>
                    <div class="info-box-footer">Enrolled learners</div>
                </div>

                <div class="info-box">
                    <div class="info-box-header">
                        <div class="info-box-title">Active This Week</div>
                        <div class="info-box-icon">‚úÖ</div>
                    </div>
                    <div class="info-box-value" id="activeUsers">0</div>
                    <div class="info-box-footer">Active learners</div>
                </div>

                <div class="info-box">
                    <div class="info-box-header">
                        <div class="info-box-title">Modules</div>
                        <div class="info-box-icon">üìñ</div>
                    </div>
                    <div class="info-box-value">5</div>
                    <div class="info-box-footer">Training modules</div>
                </div>

                <div class="info-box">
                    <div class="info-box-header">
                        <div class="info-box-title">Completions</div>
                        <div class="info-box-icon">üéì</div>
                    </div>
                    <div class="info-box-value" id="completedModules">0</div>
                    <div class="info-box-footer">Users with completed modules</div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-title">Recent User Activity</div>
                    <button class="btn-moodle" onclick="showTab('users')">View All Users</button>
                </div>
                <div class="section-body">
                    <table class="moodle-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>WhatsApp</th>
                                <th>Modules Completed</th>
                                <th>In Progress</th>
                                <th>Last Active</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentUsersTable">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #999;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Courses Tab -->
        <div id="coursesTab" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <div class="section-title">üìö Courses</div>
                    <div class="section-actions">
                        <button class="btn-primary-moodle" onclick="openAddCourseModal()">+ Add Course</button>
                    </div>
                </div>
                <div class="section-body">
                    <div id="coursesGrid" class="modules-grid">
                        <!-- Courses will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modules Tab -->
        <div id="modulesTab" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <div class="section-title">Training Modules</div>
                    <div class="section-actions">
                        <button class="btn-primary-moodle" onclick="alert('Module creation coming soon')">+ Add Module</button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="modules-grid" id="modulesGrid">
                        <!-- Modules will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="usersTab" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <div class="section-title">User Management</div>
                    <div class="section-actions">
                        <input type="text" class="search-bar" placeholder="Search users..." id="userSearch" onkeyup="filterUsers()">
                        <button class="btn-primary-moodle" onclick="alert('Add user via WhatsApp enrollment')">+ Enroll User</button>
                    </div>
                </div>
                <div class="section-body">
                    <div id="usersListContainer">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Course Modal - Selection Screen -->
    <div class="chat-modal" id="addCourseModal">
        <div class="chat-modal-content" style="max-width: 800px;">
            <div class="chat-modal-header">
                <div class="chat-modal-title">Create New Course</div>
                <button class="chat-modal-close" onclick="closeAddCourseModal()">√ó</button>
            </div>
            <div style="padding: 40px;">
                <div style="text-align:center; margin-bottom:30px; color:#666;">
                    <h3 style="margin-bottom:10px; color:#333;">Choose how you want to create your course</h3>
                    <p>Select one of the options below to get started</p>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <!-- Option 1: Manual Create -->
                    <div onclick="showManualCourseForm()" style="border:2px solid #e0e0e0; border-radius:12px; padding:30px; cursor:pointer; transition:all 0.3s; text-align:center;"
                         onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.2)'"
                         onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                        <div style="font-size:48px; margin-bottom:15px;">üìù</div>
                        <h3 style="margin-bottom:10px; color:#333;">Create Manually</h3>
                        <p style="color:#666; font-size:14px; margin-bottom:15px;">Build your course from scratch with local content upload</p>
                        <ul style="text-align:left; color:#666; font-size:13px; list-style:none; padding:0;">
                            <li style="margin-bottom:8px;">‚úì Create course details</li>
                            <li style="margin-bottom:8px;">‚úì Add modules</li>
                            <li style="margin-bottom:8px;">‚úì Upload PDF, DOCX, TXT files</li>
                            <li style="margin-bottom:8px;">‚úì Generate quizzes from content</li>
                        </ul>
                    </div>

                    <!-- Option 2: Import from Moodle -->
                    <div onclick="showMoodleImportForm()" style="border:2px solid #e0e0e0; border-radius:12px; padding:30px; cursor:pointer; transition:all 0.3s; text-align:center;"
                         onmouseover="this.style.borderColor='#f98012'; this.style.boxShadow='0 4px 12px rgba(249,128,18,0.2)'"
                         onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                        <div style="font-size:48px; margin-bottom:15px;">üîó</div>
                        <h3 style="margin-bottom:10px; color:#333;">Import from Moodle</h3>
                        <p style="color:#666; font-size:14px; margin-bottom:15px;">Import an existing course from your Moodle LMS</p>
                        <ul style="text-align:left; color:#666; font-size:13px; list-style:none; padding:0;">
                            <li style="margin-bottom:8px;">‚úì Connect to Moodle instance</li>
                            <li style="margin-bottom:8px;">‚úì Select course to import</li>
                            <li style="margin-bottom:8px;">‚úì Auto-import modules</li>
                            <li style="margin-bottom:8px;">‚úì Sync quizzes and content</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Course Creation Form Modal -->
    <div class="chat-modal" id="manualCourseModal">
        <div class="chat-modal-content" style="max-width: 700px;">
            <div class="chat-modal-header">
                <div>
                    <div class="chat-modal-title">üìù Create Course Manually</div>
                    <div class="chat-modal-subtitle">Build your course from scratch</div>
                </div>
                <button class="chat-modal-close" onclick="closeManualCourseModal()">√ó</button>
            </div>
            <div style="padding: 30px;">
                <div style="margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">Course Name *</label>
                    <input type="text" id="manualCourseName" placeholder="e.g., Teacher Training Fundamentals" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">Course Code</label>
                    <input type="text" id="manualCourseCode" placeholder="e.g., TEACH-001" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">Description</label>
                    <textarea id="manualCourseDescription" rows="4" placeholder="Brief description of the course..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px;"></textarea>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">Category</label>
                    <input type="text" id="manualCourseCategory" placeholder="e.g., Teacher Development" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                </div>

                <div style="background:#f0f7ff; border-left:4px solid #667eea; padding:15px; margin-bottom:20px; border-radius:6px;">
                    <div style="font-weight:600; margin-bottom:5px; color:#333;">üìö Next Steps</div>
                    <div style="font-size:13px; color:#666;">After creating the course, you'll be able to add modules and upload content files (PDF, DOCX, TXT).</div>
                </div>

                <div style="display:flex; gap:10px; justify-content:space-between;">
                    <button class="btn-moodle" onclick="closeManualCourseModal(); openAddCourseModal();">‚Üê Back</button>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-moodle" onclick="closeManualCourseModal()">Cancel</button>
                        <button class="btn-primary-moodle" onclick="createManualCourse()">Create Course</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Moodle Import Form Modal -->
    <div class="chat-modal" id="moodleImportModal" style="z-index: 2050;">
        <div class="chat-modal-content" style="max-width: 700px;">
            <div class="chat-modal-header">
                <div>
                    <div class="chat-modal-title">üîó Import from Moodle</div>
                    <div class="chat-modal-subtitle">Connect to your Moodle LMS and import a course</div>
                </div>
                <button class="chat-modal-close" onclick="closeMoodleImportModal()">√ó</button>
            </div>
            <div style="padding: 30px;">
                <!-- Step 1: Moodle Connection -->
                <div id="moodleStep1">
                    <h4 style="margin-bottom:15px; color:#333;">Step 1: Connect to Moodle</h4>

                    <div style="margin-bottom: 20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:600;">Moodle URL *</label>
                        <input type="text" id="moodleUrl" placeholder="https://your-moodle.com" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                        <div style="font-size:12px; color:#666; margin-top:5px;">Enter the full URL of your Moodle instance</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:600;">API Token *</label>
                        <input type="password" id="moodleToken" placeholder="Your Moodle web service token" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                        <div style="font-size:12px; color:#666; margin-top:5px;">
                            <a href="https://docs.moodle.org/en/Using_web_services" target="_blank" style="color:#667eea;">How to get your API token</a>
                        </div>
                    </div>

                    <div style="background:#e3f2fd; border-left:4px solid #2196f3; padding:15px; margin-bottom:20px; border-radius:6px;">
                        <div style="font-weight:600; margin-bottom:5px; color:#333;">üí° Tip</div>
                        <div style="font-size:13px; color:#666;">
                            Save your Moodle credentials for future use:
                            <a href="moodle-settings.html" target="_blank" style="color:#2196f3; text-decoration:underline;">Go to Moodle Settings</a>
                        </div>
                    </div>

                    <div style="background:#fff9e6; border-left:4px solid #f98012; padding:15px; margin-bottom:20px; border-radius:6px;">
                        <div style="font-weight:600; margin-bottom:5px; color:#333;">‚ö†Ô∏è Important</div>
                        <div style="font-size:13px; color:#666;">Make sure your Moodle web services are enabled and the token has permissions to read course data.</div>
                    </div>

                    <div style="display:flex; gap:10px; justify-content:space-between;">
                        <button class="btn-moodle" onclick="closeMoodleImportModal(); openAddCourseModal();">‚Üê Back</button>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-moodle" onclick="closeMoodleImportModal()">Cancel</button>
                            <button class="btn-primary-moodle" onclick="testMoodleConnection()">Test Connection & Continue</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Select Course (Hidden initially) -->
                <div id="moodleStep2" style="display:none;">
                    <h4 style="margin-bottom:15px; color:#333;">Step 2: Select Course to Import</h4>

                    <div style="margin-bottom: 20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:600;">Available Courses</label>
                        <select id="moodleCourseSelect" size="6" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                            <option value="">Loading courses...</option>
                        </select>
                        <div style="font-size:12px; color:#666; margin-top:5px;" id="courseCount">0 courses found</div>
                    </div>

                    <div style="background:#fff3cd; border-left:4px solid #ffc107; padding:15px; margin-bottom:20px; border-radius:6px;">
                        <div style="font-weight:600; margin-bottom:10px; color:#333;">üí° Alternative: Manual Course ID</div>
                        <div style="font-size:13px; color:#666; margin-bottom:10px;">If you know the Moodle course ID, you can enter it directly:</div>
                        <input type="number" id="manualCourseId" placeholder="Enter course ID (e.g., 11)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px;">
                        <div style="font-size:12px; color:#666; margin-top:5px;">Find the course ID in your Moodle course URL: .../course/view.php?id=<strong>11</strong></div>
                    </div>

                    <div id="selectedCourseInfo" style="background:#f0f7ff; border-left:4px solid #667eea; padding:15px; margin-bottom:20px; border-radius:6px; display:none;">
                        <div style="font-weight:600; margin-bottom:5px; color:#333;">Selected Course</div>
                        <div style="font-size:13px; color:#666;" id="selectedCourseDetails"></div>
                    </div>

                    <div style="display:flex; gap:10px; justify-content:space-between;">
                        <button class="btn-moodle" onclick="showMoodleStep1()">‚Üê Back</button>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-moodle" onclick="closeMoodleImportModal()">Cancel</button>
                            <button class="btn-primary-moodle" onclick="importFromMoodle()" id="importBtn" disabled>Import Course</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Module Modal -->
    <div class="chat-modal" id="addModuleModal" style="z-index: 2100;">
        <div class="chat-modal-content" style="max-width: 600px;">
            <div class="chat-modal-header">
                <div class="chat-modal-title">Add Module to Course</div>
                <button class="chat-modal-close" onclick="closeAddModuleModal()">√ó</button>
            </div>
            <div style="padding: 30px;">
                <input type="hidden" id="moduleCourseId">
                <div style="margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">Module Name *</label>
                    <input type="text" id="moduleName" placeholder="e.g., Introduction to Teaching" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">Description</label>
                    <textarea id="moduleDescription" rows="4" placeholder="Brief description of the module..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px;"></textarea>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">Sequence Order</label>
                    <input type="number" id="moduleSequence" value="1" min="1" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn-moodle" onclick="closeAddModuleModal()">Cancel</button>
                    <button class="btn-primary-moodle" onclick="createModule()">Add Module</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Course Modules Modal -->
    <div class="chat-modal" id="viewCourseModal">
        <div class="chat-modal-content" style="max-width: 900px;">
            <div class="chat-modal-header">
                <div>
                    <div class="chat-modal-title" id="viewCourseTitle">Course Modules</div>
                    <div class="chat-modal-subtitle" id="viewCourseSubtitle"></div>
                </div>
                <button class="chat-modal-close" onclick="closeViewCourseModal()">√ó</button>
            </div>
            <div style="padding: 30px;">
                <input type="hidden" id="viewCourseId">
                <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">Modules</h3>
                    <button class="btn-primary-moodle" onclick="openAddModuleModalForCourse()">+ Add Module</button>
                </div>
                <div id="courseModulesList" style="max-height:60vh; overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
                    <!-- Modules will be loaded here (scrollable list) -->
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-modal-content">
            <div class="chat-modal-header">
                <div>
                    <div class="chat-modal-title" id="chatModalTitle">Test Module Content</div>
                    <div class="chat-modal-subtitle" id="chatModalSubtitle">Ask questions about uploaded documents</div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn-module-action" onclick="clearChatModal()" style="background: #ef4444; padding: 8px 16px; font-size: 13px;" title="Clear chat history">üóëÔ∏è Clear Chat</button>
                    <button class="chat-modal-close" onclick="closeChatModal()">√ó</button>
                </div>
            </div>

            <div class="chat-messages-area" id="chatMessagesArea">
                <div class="chat-msg">
                    <div class="chat-msg-avatar">AI</div>
                    <div class="chat-msg-bubble">
                        <div class="chat-msg-text">Hello! I can answer questions about the content uploaded to this module. Try asking me about the training materials!</div>
                        <div class="chat-msg-time" id="welcomeTime"></div>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <textarea
                        class="chat-textarea"
                        id="chatInput"
                        placeholder="Ask a question about this module's content..."
                        rows="2"
                        onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendChatMessage();}"
                    ></textarea>
                    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Content Modal -->
    <div class="chat-modal" id="uploadModal">
        <div class="chat-modal-content" style="max-width: 600px;">
            <div class="chat-modal-header">
                <div>
                    <div class="chat-modal-title" id="uploadModalTitle">Upload Training Content</div>
                    <div class="chat-modal-subtitle" id="uploadModalSubtitle">Upload PDF, DOCX, or TXT files</div>
                </div>
                <button class="chat-modal-close" onclick="closeUploadModal()">√ó</button>
            </div>

            <div style="padding: 30px;">
                <!-- Drag and Drop Zone -->
                <div id="dropZone" style="
                    border: 3px dashed #667eea;
                    border-radius: 12px;
                    padding: 40px;
                    text-align: center;
                    background: #f8f9ff;
                    cursor: pointer;
                    transition: all 0.3s;
                    margin-bottom: 20px;"
                    onclick="document.getElementById('fileInput').click()"
                    ondragover="event.preventDefault(); this.style.borderColor='#4a5fc1'; this.style.background='#e8ebff';"
                    ondragleave="this.style.borderColor='#667eea'; this.style.background='#f8f9ff';"
                    ondrop="handleDrop(event)">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                    <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 10px;">
                        Drop files here or click to browse
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        Supported formats: PDF, DOCX, TXT (Max 10MB each)
                    </div>
                </div>

                <input type="file" id="fileInput" multiple accept=".pdf,.docx,.txt" style="display: none;" onchange="handleFiles(this.files)">

                <!-- Selected Files List -->
                <div id="selectedFilesList" style="margin-bottom: 20px;"></div>

                <!-- Progress Bar -->
                <div id="uploadProgress" style="display: none; margin-bottom: 20px;">
                    <div style="background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden;">
                        <div id="progressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="progressText" style="text-align: center; margin-top: 8px; font-size: 14px; color: #666;"></div>
                </div>

                <!-- Upload Button -->
                <button id="uploadBtn" class="btn-primary-moodle" onclick="uploadFiles()" style="width: 100%; padding: 15px; font-size: 16px;" disabled>
                    üì§ Upload Files
                </button>
            </div>
        </div>
    </div>

    <!-- Upload Quiz Modal -->
    <div class="chat-modal" id="quizUploadModal">
        <div class="chat-modal-content" style="max-width: 700px;">
            <div class="chat-modal-header">
                <div>
                    <div class="chat-modal-title" id="quizUploadModalTitle">Upload Quiz</div>
                    <div class="chat-modal-subtitle" id="quizUploadModalSubtitle">Upload quiz as JSON file</div>
                </div>
                <button class="chat-modal-close" onclick="closeQuizUploadModal()">√ó</button>
            </div>

            <div style="padding: 30px;">
                <!-- Quiz Format Info -->
                <div style="background:#e3f2fd; border-left:4px solid #1976d2; padding:15px; margin-bottom:20px; border-radius:4px;">
                    <div style="font-weight:600; margin-bottom:8px; color:#1976d2;">üìã Quiz JSON Format:</div>
                    <pre style="background:white; padding:10px; border-radius:4px; overflow-x:auto; font-size:12px; margin:10px 0;">
{
  "questions": [
    {
      "question": "What is the capital of France?",
      "options": ["London", "Paris", "Berlin", "Madrid"],
      "correctAnswer": 1,
      "explanation": "Paris is the capital of France"
    }
  ]
}</pre>
                    <div style="font-size:13px; color:#555; margin-top:8px;">
                        ‚Ä¢ <strong>correctAnswer</strong>: Index of correct option (0, 1, 2, 3)<br>
                        ‚Ä¢ Each question must have 2-4 options<br>
                        ‚Ä¢ <strong>explanation</strong> is optional
                    </div>
                </div>

                <!-- File Drop Zone -->
                <div id="quizDropZone"
                     style="border:2px dashed #ccc; border-radius:8px; padding:40px; text-align:center; background:#f9f9f9; cursor:pointer; transition:all 0.3s;"
                     ondragover="handleQuizDragOver(event)"
                     ondragleave="handleQuizDragLeave(event)"
                     ondrop="handleQuizDrop(event)"
                     onclick="document.getElementById('quizFileInput').click()">
                    <div style="font-size:48px; margin-bottom:15px;">üìù</div>
                    <div style="font-size:16px; color:#333; margin-bottom:8px;">Drop quiz JSON file here or click to browse</div>
                    <div style="font-size:13px; color:#999;">Supported format: .json</div>
                    <input type="file" id="quizFileInput" accept=".json" style="display:none;" onchange="handleQuizFileSelect(event)">
                </div>

                <!-- Selected Quiz File -->
                <div id="selectedQuizFile" style="margin-top:20px; display:none;">
                    <div style="background:white; border:1px solid #e0e0e0; border-radius:8px; padding:15px;">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <div style="font-size:24px;">üìÑ</div>
                                <div>
                                    <div id="quizFileName" style="font-weight:600; color:#333;"></div>
                                    <div id="quizFileSize" style="font-size:13px; color:#999; margin-top:2px;"></div>
                                    <div id="quizQuestionCount" style="font-size:13px; color:#1976d2; margin-top:2px; font-weight:500;"></div>
                                </div>
                            </div>
                            <button onclick="clearQuizFile()" style="background:none; border:none; color:#999; font-size:24px; cursor:pointer; padding:5px;"
                                    title="Remove file">√ó</button>
                        </div>
                    </div>
                </div>

                <!-- Upload Progress -->
                <div id="quizUploadProgress" style="display:none; margin-top:20px;">
                    <div style="width:100%; background:#e0e0e0; border-radius:20px; overflow:hidden; height:8px;">
                        <div id="quizProgressBar" style="width:0%; background:#1976d2; height:100%; transition:width 0.3s;"></div>
                    </div>
                    <div id="quizProgressText" style="text-align: center; margin-top: 8px; font-size: 14px; color: #666;"></div>
                </div>

                <!-- Upload Button -->
                <button id="quizUploadBtn" class="btn-primary-moodle" onclick="uploadQuizFile()" style="width: 100%; padding: 15px; font-size: 16px; margin-top:20px;" disabled>
                    üì§ Upload Quiz
                </button>

                <!-- Download Sample -->
                <div style="text-align:center; margin-top:15px;">
                    <button class="btn-moodle" onclick="downloadQuizSample()" style="padding:8px 16px; font-size:14px;">
                        üì• Download Sample Quiz JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/admin';
        let authToken = localStorage.getItem('adminToken');
        let allUsers = [];
        let allModules = [];
        let allCourses = [];
        let currentChatModuleId = null;
        let currentChatModuleTitle = null;
        let currentCourseId = null;
        let currentUploadModuleId = null;
        let selectedFiles = [];

        // Check authentication
        if (!authToken) {
            window.location.href = 'login.html';
        }

        // Load user info
        const user = JSON.parse(localStorage.getItem('adminUser') || '{}');
        if (user.name) {
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            loadModules();
            loadUsers();
            loadCourses();
        });

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Update breadcrumb
            document.getElementById('currentSection').textContent =
                tabName.charAt(0).toUpperCase() + tabName.slice(1);

            // Make nav tab active
            event.target.classList.add('active');
        }

        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load data');

                const result = await response.json();
                const users = result.data || [];

                document.getElementById('totalUsers').textContent = users.length;

                const activeCount = users.filter(u => u.last_active_at).length;
                document.getElementById('activeUsers').textContent = activeCount;

                // Count users who completed at least one module
                const usersWithCompletions = users.filter(u => u.current_module_id > 1).length;
                document.getElementById('completedModules').textContent = usersWithCompletions;

                // Load recent users table
                displayRecentUsers(users.slice(0, 10));

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function displayRecentUsers(users) {
            const tbody = document.getElementById('recentUsersTable');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No users yet</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const lastActive = user.last_active_at
                    ? new Date(user.last_active_at).toLocaleDateString()
                    : 'Never';
                const completed = user.modules_completed || 0;
                const inProgress = user.modules_in_progress || 0;
                const isActive = user.last_active_at ? 'Active' : 'Enrolled';

                return `
                    <tr onclick="window.location.href='user-detail.html?id=${user.id}'" style="cursor: pointer;">
                        <td><strong>${user.name}</strong></td>
                        <td>${user.whatsapp_id}</td>
                        <td>${completed}</td>
                        <td>${inProgress}</td>
                        <td>${lastActive}</td>
                        <td><span class="badge-moodle badge-${isActive === 'Active' ? 'success' : 'info'}">${isActive}</span></td>
                    </tr>
                `;
            }).join('');
        }

        async function loadModules() {
            try {
                const response = await fetch(`${API_BASE}/modules`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load modules');

                const result = await response.json();
                allModules = result.data || [];

                displayModules(allModules);

            } catch (error) {
                console.error('Error loading modules:', error);
            }
        }

        function displayModules(modules) {
            const grid = document.getElementById('modulesGrid');

            grid.innerHTML = modules.map(module => `
                <div class="module-card">
                    <div class="module-card-header">
                        <div class="module-number">Module ${module.sequence_order}</div>
                        <div class="module-title">${module.title}</div>
                        <div class="module-description">${module.description}</div>
                    </div>
                    <div class="module-card-body">
                        <div class="module-stats">
                            <div class="module-stat">
                                <div class="module-stat-value" id="files_${module.id}">-</div>
                                <div class="module-stat-label">Files</div>
                            </div>
                            <div class="module-stat">
                                <div class="module-stat-value" id="chunks_${module.id}">-</div>
                                <div class="module-stat-label">Chunks</div>
                            </div>
                            <div class="module-stat">
                                <div class="module-stat-value">5</div>
                                <div class="module-stat-label">Quiz Qs</div>
                            </div>
                        </div>
                        <div class="module-actions">
                            <button class="btn-moodle" onclick="openUploadModal(${module.id}, '${module.title}')">üì§ Upload</button>
                            <button class="btn-moodle" onclick="openChatModal(${module.id}, '${module.title}')">üí¨ Test Chat</button>
                            <button class="btn-moodle" onclick="window.location.href='quiz.html?module=${module.id}'">üìù Quiz</button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Load content stats for each module
            modules.forEach(m => loadModuleContent(m.id));
        }

        async function loadModuleContent(moduleId) {
            try {
                const response = await fetch(`${API_BASE}/modules/${moduleId}/content`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    const content = result.data;
                    const totalChunks = content.reduce((sum, item) => sum + (item.chunk_count || 0), 0);

                    document.getElementById(`files_${moduleId}`).textContent = content.length;
                    document.getElementById(`chunks_${moduleId}`).textContent = totalChunks;
                }
            } catch (error) {
                console.error(`Error loading module ${moduleId} content:`, error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load users');

                const result = await response.json();
                allUsers = result.data || [];

                displayUsers(allUsers);

            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersListContainer');

            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h3>No users yet</h3>
                        <p>Users will appear here when they enroll via WhatsApp</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = users.map(user => {
                const completed = user.modules_completed || 0;
                const inProgress = user.modules_in_progress || 0;
                const quizzes = user.quizzes_passed || 0;
                const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2);

                return `
                    <div class="user-item" onclick="window.location.href='user-detail.html?id=${user.id}'">
                        <div class="user-item-avatar">${initials}</div>
                        <div class="user-item-info">
                            <div class="user-item-name">${user.name}</div>
                            <div class="user-item-meta">${user.whatsapp_id}</div>
                        </div>
                        <div class="user-item-stats">
                            <div>
                                <strong>${completed}</strong> completed
                            </div>
                            <div>
                                <strong>${inProgress}</strong> in progress
                            </div>
                            <div>
                                <strong>${quizzes}</strong> quizzes passed
                            </div>
                        </div>
                        <span class="badge-moodle badge-${completed > 0 ? 'success' : 'info'}">
                            ${completed > 0 ? 'Active' : 'Enrolled'}
                        </span>
                    </div>
                `;
            }).join('');
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(user =>
                user.name.toLowerCase().includes(searchTerm) ||
                user.whatsapp_id.includes(searchTerm)
            );
            displayUsers(filtered);
        }

        function handleLogout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Chat Modal Functions
        async function openChatModal(moduleId, moduleTitle) {
            currentChatModuleId = moduleId;
            currentChatModuleTitle = moduleTitle;

            document.getElementById('chatModalTitle').textContent = `Test Chat - ${moduleTitle}`;
            document.getElementById('chatModalSubtitle').textContent = `Module ${moduleId}: Ask questions about uploaded documents`;

            // Clear chat area
            const messagesArea = document.getElementById('chatMessagesArea');
            messagesArea.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;">Loading chat history...</div>';

            document.getElementById('chatModal').classList.add('active');

            // Load chat history from database
            try {
                const response = await fetch(`/api/chat/history?module_id=${moduleId}&user_id=1&limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    // Clear loading message
                    messagesArea.innerHTML = '';

                    if (data.messages && data.messages.length > 0) {
                        // Display existing conversation history
                        data.messages.forEach(msg => {
                            const sender = msg.role === 'user' ? 'user' : 'assistant';
                            let sources = null;
                            if (msg.role === 'assistant' && msg.sources && msg.sources.length > 0) {
                                // Extract titles and remove duplicates
                                const allSources = msg.sources.map(s => s.title || 'Unknown');
                                sources = [...new Set(allSources)];
                            }
                            addChatMessage(msg.content, sender, sources);
                        });
                    } else {
                        // Show welcome message if no history
                        messagesArea.innerHTML = `
                            <div class="chat-msg">
                                <div class="chat-msg-avatar">AI</div>
                                <div class="chat-msg-bubble">
                                    <div class="chat-msg-text">Hello! I can answer questions about the content uploaded to <strong>${moduleTitle}</strong>. Try asking me about the training materials!</div>
                                    <div class="chat-msg-time">${formatTime()}</div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Failed to load chat history');
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                // Show welcome message on error
                messagesArea.innerHTML = `
                    <div class="chat-msg">
                        <div class="chat-msg-avatar">AI</div>
                        <div class="chat-msg-bubble">
                            <div class="chat-msg-text">Hello! I can answer questions about the content uploaded to <strong>${moduleTitle}</strong>. Try asking me about the training materials!</div>
                            <div class="chat-msg-time">${formatTime()}</div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('chatInput').focus();
        }

        function closeChatModal() {
            document.getElementById('chatModal').classList.remove('active');
            currentChatModuleId = null;
            currentChatModuleTitle = null;
        }

        async function clearChatModal() {
            if (!currentChatModuleId || !currentChatModuleTitle) return;

            if (confirm('Are you sure you want to clear this chat history? This will delete the conversation memory.')) {
                try {
                    // Clear session in database
                    const response = await fetch(`/api/chat/clear`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: 1,
                            module_id: currentChatModuleId
                        })
                    });

                    if (response.ok) {
                        // Clear UI
                        const messagesArea = document.getElementById('chatMessagesArea');
                        messagesArea.innerHTML = `
                            <div class="chat-msg">
                                <div class="chat-msg-avatar">AI</div>
                                <div class="chat-msg-bubble">
                                    <div class="chat-msg-text">Hello! I can answer questions about the content uploaded to <strong>${currentChatModuleTitle}</strong>. Try asking me about the training materials!</div>
                                    <div class="chat-msg-time">${formatTime()}</div>
                                </div>
                            </div>
                        `;
                        showSnackbar('Chat history cleared successfully', 'success');
                    } else {
                        showSnackbar('Failed to clear chat history', 'error');
                    }
                } catch (error) {
                    console.error('Error clearing chat:', error);
                    showSnackbar('Error clearing chat history', 'error');
                }
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !currentChatModuleId) return;

            const sendBtn = document.getElementById('chatSendBtn');
            const messagesArea = document.getElementById('chatMessagesArea');

            // Add user message
            addChatMessage(message, 'user');

            // Clear input and disable send
            input.value = '';
            sendBtn.disabled = true;

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-msg';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="chat-msg-avatar">AI</div>
                <div class="chat-msg-bubble">
                    <div class="typing-indicator-msg">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            messagesArea.appendChild(typingDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;

            try {
                const response = await fetch(`/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        module_id: currentChatModuleId,
                        user_id: 1,  // Default user ID for admin portal
                        useContext: true,
                        language: 'english'
                    })
                });

                // Remove typing indicator
                document.getElementById('typingIndicator')?.remove();

                if (!response.ok) {
                    throw new Error('Failed to get response');
                }

                const result = await response.json();

                if (result.success) {
                    // Extract unique source titles from context
                    let sources = null;
                    if (result.context && result.context.length > 0) {
                        // The server already provides title in each context document
                        const allSources = result.context.map(doc => doc.title || 'Untitled');
                        // Remove duplicates using Set
                        sources = [...new Set(allSources)];
                    }
                    addChatMessage(result.response, 'assistant', sources);
                } else {
                    addChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }

            } catch (error) {
                document.getElementById('typingIndicator')?.remove();
                addChatMessage('Failed to send message. Please check your connection.', 'assistant');
                console.error('Chat error:', error);
            } finally {
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Simple markdown parser for chat messages
        function parseMarkdown(text) {
            // Escape HTML first to prevent XSS
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Parse markdown syntax
            // Headers (must be at start of line)
            html = html.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*?)$/gm, '<h1>$1</h1>');

            // Bold: **text** or __text__
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');

            // Italic: *text* or _text_ (but not inside bold)
            html = html.replace(/(?<!\*)\*(?!\*)(.+?)\*(?!\*)/g, '<em>$1</em>');
            html = html.replace(/(?<!_)_(?!_)(.+?)_(?!_)/g, '<em>$1</em>');

            // Inline code: `code`
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Links: [text](url)
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            // Bullet lists (- item or * item)
            html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Numbered lists (1. item, 2. item, etc.)
            html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            // Find consecutive <li> tags and wrap in <ol>
            html = html.replace(/(<li>[\s\S]+?<\/li>)(?!\s*<li>)/g, function(match) {
                // Only wrap if not already in a list
                if (!match.includes('<ul>') && !match.includes('<ol>')) {
                    return '<ol>' + match + '</ol>';
                }
                return match;
            });

            // Paragraphs (double line breaks)
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';

            // Single line breaks
            html = html.replace(/\n/g, '<br>');

            // Clean up empty paragraphs
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>\s*<\/p>/g, '');

            return html;
        }

        function addChatMessage(text, sender, sources = null) {
            const messagesArea = document.getElementById('chatMessagesArea');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-msg ${sender === 'user' ? 'user-msg' : ''}`;

            const avatar = sender === 'user' ? 'You' : 'AI';
            let sourcesHtml = '';

            if (sources && sources.length > 0) {
                sourcesHtml = `
                    <div class="chat-sources">
                        üìö Sources: ${sources.map(s => `<span class="source-badge">${escapeHtml(s)}</span>`).join('')}
                    </div>
                `;
            }

            // For user messages, just escape HTML. For AI messages, parse markdown
            const formattedText = sender === 'user' ? escapeHtml(text) : parseMarkdown(text);

            msgDiv.innerHTML = `
                <div class="chat-msg-avatar">${avatar.substring(0, 2)}</div>
                <div class="chat-msg-bubble">
                    <div class="chat-msg-text">${formattedText}</div>
                    ${sourcesHtml}
                    <div class="chat-msg-time">${formatTime()}</div>
                </div>
            `;

            messagesArea.appendChild(msgDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function formatTime() {
            return new Date().toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // Upload Modal Functions
        function openUploadModal(moduleId, moduleTitle) {
            currentUploadModuleId = moduleId;
            document.getElementById('uploadModalTitle').textContent = `Upload Content - ${moduleTitle}`;
            document.getElementById('uploadModalSubtitle').textContent = `Module ${moduleId}: Upload training materials`;
            document.getElementById('uploadModal').classList.add('active');

            // Reset upload state
            selectedFiles = [];
            document.getElementById('selectedFilesList').innerHTML = '';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadProgress').style.display = 'none';
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            currentUploadModuleId = null;
            selectedFiles = [];
        }

        // Quiz Upload Modal Functions
        let currentQuizUploadModuleId = null;
        let selectedQuizFile = null;
        let quizData = null;

        function openQuizUploadModal(moduleId, moduleTitle) {
            currentQuizUploadModuleId = moduleId;
            console.log('üìù Opening quiz upload modal for Module ID:', moduleId, 'Title:', moduleTitle);

            document.getElementById('quizUploadModalTitle').textContent = `Upload Quiz - ${moduleTitle}`;
            document.getElementById('quizUploadModalSubtitle').textContent = `Database Module ID: ${moduleId} | Upload quiz questions in JSON format`;
            document.getElementById('quizUploadModal').classList.add('active');

            // Reset state
            clearQuizFile();
        }

        function closeQuizUploadModal() {
            document.getElementById('quizUploadModal').classList.remove('active');
            currentQuizUploadModuleId = null;
            clearQuizFile();
        }

        function clearQuizFile() {
            selectedQuizFile = null;
            quizData = null;
            document.getElementById('selectedQuizFile').style.display = 'none';
            document.getElementById('quizUploadBtn').disabled = true;
            document.getElementById('quizUploadProgress').style.display = 'none';
            document.getElementById('quizFileInput').value = '';
        }

        function handleQuizDragOver(event) {
            event.preventDefault();
            const dropZone = document.getElementById('quizDropZone');
            dropZone.style.borderColor = '#1976d2';
            dropZone.style.background = '#e3f2fd';
        }

        function handleQuizDragLeave(event) {
            const dropZone = document.getElementById('quizDropZone');
            dropZone.style.borderColor = '#ccc';
            dropZone.style.background = '#f9f9f9';
        }

        function handleQuizDrop(event) {
            event.preventDefault();
            const dropZone = document.getElementById('quizDropZone');
            dropZone.style.borderColor = '#ccc';
            dropZone.style.background = '#f9f9f9';

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processQuizFile(files[0]);
            }
        }

        function handleQuizFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                processQuizFile(files[0]);
            }
        }

        async function processQuizFile(file) {
            // Validate file type
            if (!file.name.endsWith('.json')) {
                showSnackbar('‚ùå Only .json files are supported', 'error');
                return;
            }

            // Validate file size (max 1MB)
            if (file.size > 1024 * 1024) {
                showSnackbar('‚ùå File too large. Maximum size is 1MB', 'error');
                return;
            }

            try {
                // Read and parse JSON
                const text = await file.text();
                const data = JSON.parse(text);

                // Validate quiz structure
                if (!data.questions || !Array.isArray(data.questions)) {
                    showSnackbar('‚ùå Invalid quiz format: "questions" array is required', 'error');
                    return;
                }

                if (data.questions.length === 0) {
                    showSnackbar('‚ùå Quiz must contain at least one question', 'error');
                    return;
                }

                // Validate each question
                for (let i = 0; i < data.questions.length; i++) {
                    const q = data.questions[i];
                    if (!q.question || !q.options || !Array.isArray(q.options)) {
                        showSnackbar(`‚ùå Question ${i + 1}: Invalid format`, 'error');
                        return;
                    }
                    if (q.options.length < 2 || q.options.length > 4) {
                        showSnackbar(`‚ùå Question ${i + 1}: Must have 2-4 options`, 'error');
                        return;
                    }
                    if (q.correctAnswer === undefined || q.correctAnswer < 0 || q.correctAnswer >= q.options.length) {
                        showSnackbar(`‚ùå Question ${i + 1}: Invalid correctAnswer index`, 'error');
                        return;
                    }
                }

                // Store data
                selectedQuizFile = file;
                quizData = data;

                // Update UI
                document.getElementById('quizFileName').textContent = file.name;
                document.getElementById('quizFileSize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
                document.getElementById('quizQuestionCount').textContent = `‚úì ${data.questions.length} questions validated`;
                document.getElementById('selectedQuizFile').style.display = 'block';
                document.getElementById('quizUploadBtn').disabled = false;

                showSnackbar(`‚úì Quiz validated: ${data.questions.length} questions`, 'success');

            } catch (error) {
                console.error('Error processing quiz file:', error);
                showSnackbar('‚ùå Invalid JSON file: ' + error.message, 'error');
            }
        }

        async function uploadQuizFile() {
            if (!selectedQuizFile || !quizData || !currentQuizUploadModuleId) {
                showSnackbar('‚ùå Please select a quiz file first', 'error');
                return;
            }

            const uploadBtn = document.getElementById('quizUploadBtn');
            const progressDiv = document.getElementById('quizUploadProgress');
            const progressBar = document.getElementById('quizProgressBar');
            const progressText = document.getElementById('quizProgressText');

            try {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';
                progressDiv.style.display = 'block';
                progressBar.style.width = '30%';
                progressText.textContent = 'Uploading quiz...';

                console.log('üöÄ Uploading quiz to module ID:', currentQuizUploadModuleId);
                const response = await fetch(`${API_BASE}/modules/${currentQuizUploadModuleId}/quiz/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quizData)
                });

                progressBar.style.width = '70%';

                const result = await response.json();

                if (result.success) {
                    progressBar.style.width = '100%';
                    progressText.textContent = `‚úÖ Quiz uploaded: ${quizData.questions.length} questions`;

                    showSnackbar(`‚úÖ Quiz uploaded successfully!`, 'success');

                    setTimeout(() => {
                        closeQuizUploadModal();
                        loadCourses(); // Reload to show updated data
                    }, 1500);

                } else {
                    throw new Error(result.error || 'Upload failed');
                }

            } catch (error) {
                console.error('Quiz upload error:', error);
                showSnackbar('‚ùå Upload failed: ' + error.message, 'error');
                progressDiv.style.display = 'none';
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Upload Quiz';
            }
        }

        function downloadQuizSample() {
            const sample = {
                "questions": [
                    {
                        "question": "What is the PRIMARY goal of effective classroom management?",
                        "options": [
                            "To maintain strict discipline",
                            "To create a positive learning environment",
                            "To reduce teacher workload",
                            "To increase test scores"
                        ],
                        "correctAnswer": 1,
                        "explanation": "The primary goal is to create a positive learning environment where students feel safe, engaged, and motivated to learn."
                    },
                    {
                        "question": "Which strategy is MOST effective for preventing classroom disruptions?",
                        "options": [
                            "Setting clear expectations from day one",
                            "Using harsh punishments",
                            "Ignoring minor misbehaviors",
                            "Letting students create their own rules"
                        ],
                        "correctAnswer": 0,
                        "explanation": "Setting clear expectations and consistently enforcing them prevents confusion and reduces disruptions."
                    },
                    {
                        "question": "What does 'proximity control' mean in classroom management?",
                        "options": [
                            "Keeping students close to the teacher's desk",
                            "Moving near students to redirect behavior without verbal intervention",
                            "Controlling classroom temperature",
                            "Managing classroom seating arrangements"
                        ],
                        "correctAnswer": 1,
                        "explanation": "Proximity control involves the teacher physically moving closer to students to prevent or redirect off-task behavior non-verbally."
                    }
                ]
            };

            const blob = new Blob([JSON.stringify(sample, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample-quiz.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showSnackbar('üì• Sample quiz downloaded', 'success');
        }

        function handleDrop(event) {
            event.preventDefault();
            const dropZone = document.getElementById('dropZone');
            dropZone.style.borderColor = '#667eea';
            dropZone.style.background = '#f8f9ff';

            const files = event.dataTransfer.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => {
                const ext = file.name.toLowerCase();
                return ext.endsWith('.pdf') || ext.endsWith('.docx') || ext.endsWith('.txt');
            });

            displaySelectedFiles();
            document.getElementById('uploadBtn').disabled = selectedFiles.length === 0;
        }

        function displaySelectedFiles() {
            const container = document.getElementById('selectedFilesList');

            if (selectedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Selected Files (${selectedFiles.length}):</div>
                    ${selectedFiles.map((file, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 6px; margin-bottom: 6px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">${getFileIcon(file.name)}</span>
                                <div>
                                    <div style="font-size: 14px; font-weight: 500; color: #333;">${file.name}</div>
                                    <div style="font-size: 12px; color: #666;">${(file.size / 1024).toFixed(1)} KB</div>
                                </div>
                            </div>
                            <button onclick="removeFile(${index})" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getFileIcon(filename) {
            if (filename.endsWith('.pdf')) return 'üìï';
            if (filename.endsWith('.docx')) return 'üìò';
            if (filename.endsWith('.txt')) return 'üìÑ';
            return 'üìÅ';
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displaySelectedFiles();
            document.getElementById('uploadBtn').disabled = selectedFiles.length === 0;
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0 || !currentUploadModuleId) return;

            const uploadBtn = document.getElementById('uploadBtn');
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            progressDiv.style.display = 'block';

            const formData = new FormData();

            try {
                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `Uploading... ${progress}%`;
                    }
                }, 200);

                // Upload each file individually to the correct endpoint
                let totalChunks = 0;
                for (const file of selectedFiles) {
                    const fileFormData = new FormData();
                    fileFormData.append('file', file);

                    const response = await fetch(`${API_BASE}/modules/${currentUploadModuleId}/content`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: fileFormData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Upload failed');
                    }

                    const result = await response.json();
                    if (result.success) {
                        totalChunks++;
                    }
                }

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = '‚úÖ Upload complete!';

                showSnackbar(`Successfully uploaded ${totalChunks} file(s)!`, 'success');

                setTimeout(() => {
                    closeUploadModal();
                    // Reload module content
                    if (currentCourseId) {
                        loadCourseModules(currentCourseId);
                    }
                }, 1500);

            } catch (error) {
                console.error('Upload error:', error);
                showSnackbar('Upload failed: ' + error.message, 'error');
                progressDiv.style.display = 'none';
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Upload Files';
            }
        }

        // Close modal on background click
        document.getElementById('chatModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeChatModal();
            }
        });

        document.getElementById('addCourseModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddCourseModal();
            }
        });

        document.getElementById('addModuleModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddModuleModal();
            }
        });

        document.getElementById('viewCourseModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeViewCourseModal();
            }
        });

        document.getElementById('manualCourseModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeManualCourseModal();
            }
        });

        document.getElementById('moodleImportModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeMoodleImportModal();
            }
        });

        // ==================== COURSE MANAGEMENT FUNCTIONS ====================

        async function loadCourses() {
            try {
                const response = await fetch(`${API_BASE}/portal/courses`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load courses');

                const result = await response.json();
                allCourses = result.data || [];
                displayCourses(allCourses);

            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        function displayCourses(courses) {
            const grid = document.getElementById('coursesGrid');

            if (courses.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:#999;">No courses yet. Click "+ Add Course" to create your first course.</div>';
                return;
            }

            grid.innerHTML = courses.map(course => {
                // Safely get course name (handle both course_name and title)
                const courseName = (course.course_name || course.title || 'Untitled Course').replace(/'/g, "\\'");
                const courseCode = course.course_code || course.code || 'COURSE';

                return `
                    <div class="module-card">
                        <div class="module-card-header">
                            <div class="module-number">${courseCode}</div>
                            <div class="module-title">${course.course_name || course.title || 'Untitled Course'}</div>
                            <div class="module-description">${course.description || 'No description'}</div>
                        </div>
                        <div class="module-card-body">
                            <div class="module-stats">
                                <div class="module-stat">
                                    <div class="module-stat-value">${course.module_count || 0}</div>
                                    <div class="module-stat-label">Modules</div>
                                </div>
                                <div class="module-stat">
                                    <div class="module-stat-value" style="font-size:16px; color:#5f6368;">${course.category || '-'}</div>
                                    <div class="module-stat-label">Category</div>
                                </div>
                                <div class="module-stat">
                                    <div class="module-stat-value" style="font-size:16px; color:#5f6368;">${course.source_display || 'Portal'}</div>
                                    <div class="module-stat-label">Source</div>
                                </div>
                            </div>
                            <div class="module-actions" style="display:grid; grid-template-columns:1fr auto; gap:8px;">
                                <button class="btn-primary-moodle" onclick="viewCourseModules(${course.id}, '${courseName}')" style="border-radius:20px;">
                                    üìã View Modules
                                </button>
                                <button class="btn-icon btn-icon-danger" onclick="deleteCourse(${course.id}, '${courseName}');" title="Delete course">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Course Modal Functions
        function openAddCourseModal() {
            document.getElementById('addCourseModal').classList.add('active');
        }

        function closeAddCourseModal() {
            document.getElementById('addCourseModal').classList.remove('active');
        }

        // Manual Course Creation Functions
        function showManualCourseForm() {
            closeAddCourseModal();
            document.getElementById('manualCourseModal').classList.add('active');
            // Clear fields
            document.getElementById('manualCourseName').value = '';
            document.getElementById('manualCourseCode').value = '';
            document.getElementById('manualCourseDescription').value = '';
            document.getElementById('manualCourseCategory').value = '';
        }

        function closeManualCourseModal() {
            document.getElementById('manualCourseModal').classList.remove('active');
        }

        // Global function to handle API responses with token expiration
        async function handleApiResponse(response) {
            if (response.status === 401) {
                const result = await response.json();
                if (result.code === 'TOKEN_EXPIRED' || result.error === 'Token has expired') {
                    alert('Your session has expired. Please login again.');
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminUser');
                    window.location.href = 'login.html';
                    throw new Error('Token expired');
                }
            }
            return response;
        }

        async function createManualCourse() {
            const name = document.getElementById('manualCourseName').value.trim();
            const code = document.getElementById('manualCourseCode').value.trim();
            const description = document.getElementById('manualCourseDescription').value.trim();
            const category = document.getElementById('manualCourseCategory').value.trim();

            if (!name) {
                alert('Course name is required');
                return;
            }

            try {
                // Get next moodle_course_id
                const nextId = Math.max(...allCourses.map(c => c.moodle_course_id || 0), 0) + 1;

                const response = await fetch(`${API_BASE}/portal/courses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        course_name: name,
                        course_code: code || `COURSE-${nextId}`,
                        description: description,
                        category: category || 'General'
                    })
                });

                await handleApiResponse(response); // Check for token expiration

                const result = await response.json();

                if (result.success) {
                    alert('Course created successfully! You can now add modules and upload content.');
                    closeManualCourseModal();
                    loadCourses();
                } else {
                    alert(result.error || 'Failed to create course');
                }
            } catch (error) {
                console.error('Error creating course:', error);
                if (error.message !== 'Token expired') {
                    alert('Error creating course');
                }
            }
        }

        // Moodle Import Functions
        let moodleCredentials = { url: '', token: '' };
        let moodleCourses = [];

        async function showMoodleImportForm() {
            closeAddCourseModal();
            document.getElementById('moodleImportModal').classList.add('active');
            showMoodleStep1();

            // Load saved Moodle settings from database
            await loadSavedMoodleSettings();
        }

        async function loadSavedMoodleSettings() {
            try {
                console.log('Loading saved Moodle settings...');
                console.log('Token:', authToken ? 'Present' : 'Missing');

                const response = await fetch('/api/admin/moodle-settings/config', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('API response:', result);
                    const config = result.data;
                    console.log('Config data:', config);

                    // Pre-fill the form with saved settings
                    if (config.url) {
                        console.log('Setting URL:', config.url);
                        document.getElementById('moodleUrl').value = config.url;
                    }
                    if (config.token) {
                        console.log('Setting token (length):', config.token.length);
                        document.getElementById('moodleToken').value = config.token;
                    }

                    console.log('‚úÖ Settings loaded successfully');
                } else {
                    const errorText = await response.text();
                    console.error('API error:', response.status, errorText);
                }
            } catch (error) {
                console.error('Could not load saved Moodle settings:', error);
                // Silent fail - user can still enter manually
            }
        }

        function closeMoodleImportModal() {
            document.getElementById('moodleImportModal').classList.remove('active');
            moodleCredentials = { url: '', token: '' };
            moodleCourses = [];
        }

        function showMoodleStep1() {
            document.getElementById('moodleStep1').style.display = 'block';
            document.getElementById('moodleStep2').style.display = 'none';
        }

        function showMoodleStep2() {
            document.getElementById('moodleStep1').style.display = 'none';
            document.getElementById('moodleStep2').style.display = 'block';
        }

        async function testMoodleConnection() {
            const url = document.getElementById('moodleUrl').value.trim();
            const token = document.getElementById('moodleToken').value.trim();

            if (!url || !token) {
                alert('Please provide both Moodle URL and API token');
                return;
            }

            try {
                // Test connection using Moodle settings API
                const testBtn = event.target;
                testBtn.disabled = true;
                testBtn.textContent = 'Connecting...';

                const response = await fetch('/api/admin/moodle-settings/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ moodle_url: url, moodle_token: token })
                });

                const result = await response.json();

                if (result.success) {
                    // Show success info
                    console.log('‚úÖ Moodle connection successful:', result.siteInfo);
                    moodleCredentials = { url, token };
                    await loadMoodleCourses();
                    showMoodleStep2();
                } else {
                    alert(result.error || 'Failed to connect to Moodle. Please check your URL and token.');
                    testBtn.disabled = false;
                    testBtn.textContent = 'Test Connection & Continue';
                }
            } catch (error) {
                console.error('Error connecting to Moodle:', error);
                alert('Error connecting to Moodle. Please check your credentials and try again.');
                event.target.disabled = false;
                event.target.textContent = 'Test Connection & Continue';
            }
        }

        async function loadMoodleCourses() {
            try {
                console.log('Loading Moodle courses with credentials:', moodleCredentials);

                const response = await fetch(`${API_BASE}/moodle/courses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(moodleCredentials)
                });

                console.log('Courses response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Courses API error:', response.status, errorText);
                    throw new Error(`API returned ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('Courses result:', result);

                if (result.success) {
                    moodleCourses = result.data || [];
                    console.log(`Loaded ${moodleCourses.length} courses`);
                    displayMoodleCourses();
                } else {
                    console.error('Failed to load courses:', result.error);
                    document.getElementById('moodleCourseSelect').innerHTML = `<option>Failed: ${result.error || 'Unknown error'}</option>`;
                }
            } catch (error) {
                console.error('Error loading Moodle courses:', error);
                document.getElementById('moodleCourseSelect').innerHTML = `<option>Error: ${error.message}</option>`;
            }
        }

        function displayMoodleCourses() {
            const select = document.getElementById('moodleCourseSelect');

            if (moodleCourses.length === 0) {
                select.innerHTML = '<option>No courses found</option>';
                document.getElementById('courseCount').textContent = '0 courses found';
                return;
            }

            select.innerHTML = moodleCourses.map(course =>
                `<option value="${course.id}">${course.fullname} (${course.shortname})</option>`
            ).join('');

            document.getElementById('courseCount').textContent = `${moodleCourses.length} courses found`;

            // Enable selection handler
            select.onchange = function() {
                const selectedCourse = moodleCourses.find(c => c.id == this.value);
                if (selectedCourse) {
                    document.getElementById('selectedCourseInfo').style.display = 'block';
                    document.getElementById('selectedCourseDetails').innerHTML = `
                        <strong>${selectedCourse.fullname}</strong><br>
                        Course Code: ${selectedCourse.shortname}<br>
                        ID: ${selectedCourse.id}
                    `;
                    document.getElementById('importBtn').disabled = false;
                } else {
                    document.getElementById('selectedCourseInfo').style.display = 'none';
                    document.getElementById('importBtn').disabled = true;
                }
            };
        }

        async function importFromMoodle() {
            const select = document.getElementById('moodleCourseSelect');
            const manualInput = document.getElementById('manualCourseId');

            let courseId = select.value;
            let courseName = '';

            // Check if manual course ID is provided
            if (!courseId && manualInput && manualInput.value) {
                courseId = manualInput.value.trim();
                courseName = `Course ID ${courseId}`;
            } else if (courseId) {
                const selectedCourse = moodleCourses.find(c => c.id == courseId);
                if (!selectedCourse) {
                    alert('Course not found');
                    return;
                }
                courseName = selectedCourse.fullname;
            } else {
                alert('Please select a course or enter a course ID');
                return;
            }

            if (!confirm(`Import "${courseName}" from Moodle? This will import all modules and content.`)) {
                return;
            }

            try {
                const importBtn = document.getElementById('importBtn');
                importBtn.disabled = true;
                importBtn.textContent = 'Importing...';

                // Call backend API to import from Moodle
                const response = await fetch(`${API_BASE}/moodle/import-course`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        courseId: parseInt(courseId)
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const summary = result.data;
                    alert(`‚úÖ Course "${courseName}" imported successfully!\n\n` +
                          `üìä Summary:\n` +
                          `- Course: ${summary.course?.course_name || courseName}\n` +
                          `- Modules: ${summary.modules?.length || 0}\n` +
                          `- Content chunks: ${summary.totalChunks || 0}\n` +
                          `- Quizzes: ${summary.quizzes?.length || 0}\n` +
                          `- Quiz questions: ${summary.totalQuestions || 0}`);
                    closeMoodleImportModal();
                    loadCourses();
                } else {
                    alert(result.error || 'Failed to import course');
                    importBtn.disabled = false;
                    importBtn.textContent = 'Import Course';
                }
            } catch (error) {
                console.error('Error importing course:', error);
                alert('Error importing course from Moodle');
                document.getElementById('importBtn').disabled = false;
                document.getElementById('importBtn').textContent = 'Import Course';
            }
        }

        /**
         * Delete course with Material Design confirmation
         */
        async function deleteCourse(courseId, courseName) {
            // Create Material Design confirmation dialog
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 3000;
                animation: fadeIn 0.2s ease-out;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                    animation: slideUp 0.3s ease-out;
                ">
                    <div style="padding: 24px;">
                        <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
                            <div style="
                                width: 48px;
                                height: 48px;
                                border-radius: 50%;
                                background: rgba(234, 67, 53, 0.1);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 24px;
                            ">‚ö†Ô∏è</div>
                            <div style="flex:1;">
                                <h3 style="margin:0; font-size:20px; color:#202124;">Delete course?</h3>
                            </div>
                        </div>

                        <div style="color:#5f6368; line-height:1.6; margin-bottom:20px;">
                            <p style="margin:0 0 12px 0;">
                                <strong style="color:#202124;">"${courseName}"</strong> will be permanently deleted.
                            </p>
                            <div style="background:#fef7e0; border-left:4px solid #f9ab00; padding:12px; border-radius:4px; font-size:14px;">
                                <strong style="color:#202124;">This will also delete:</strong><br>
                                ‚Ä¢ All modules<br>
                                ‚Ä¢ All quizzes and questions<br>
                                ‚Ä¢ All content chunks<br>
                                ‚Ä¢ Neo4j graph data<br>
                                ‚Ä¢ ChromaDB vectors
                            </div>
                            <p style="margin:12px 0 0 0; font-weight:500; color:#ea4335;">
                                ‚ö†Ô∏è This action cannot be undone!
                            </p>
                        </div>

                        <div style="display:flex; gap:8px; justify-content:flex-end;">
                            <button onclick="this.closest('div[style*=\\'z-index: 3000\\']').remove()"
                                style="
                                    padding: 10px 24px;
                                    border: none;
                                    background: transparent;
                                    color: #1a73e8;
                                    font-size: 14px;
                                    font-weight: 500;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                "
                                onmouseover="this.style.background='rgba(26,115,232,0.08)'"
                                onmouseout="this.style.background='transparent'">
                                Cancel
                            </button>
                            <button onclick="confirmDeleteCourse(${courseId}, '${courseName.replace(/'/g, "\\'")}'); this.closest('div[style*=\\'z-index: 3000\\']').remove();"
                                style="
                                    padding: 10px 24px;
                                    border: none;
                                    background: #ea4335;
                                    color: white;
                                    font-size: 14px;
                                    font-weight: 500;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    box-shadow: 0 1px 3px rgba(234,67,53,0.3);
                                "
                                onmouseover="this.style.background='#d33828'; this.style.boxShadow='0 2px 6px rgba(234,67,53,0.4)'"
                                onmouseout="this.style.background='#ea4335'; this.style.boxShadow='0 1px 3px rgba(234,67,53,0.3)'">
                                Delete Course
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(20px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function confirmDeleteCourse(courseId, courseName) {
            try {
                const response = await fetch(`${API_BASE}/courses/${courseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Show success snackbar
                    showSnackbar(`‚úÖ Course "${courseName}" deleted successfully`, 'success');
                    loadCourses(); // Reload course list
                } else {
                    showSnackbar(`‚ùå Error: ${result.error || 'Failed to delete course'}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting course:', error);
                showSnackbar('‚ùå Error deleting course', 'error');
            }
        }

        /**
         * Show Material Design snackbar notification
         */
        function showSnackbar(message, type = 'info') {
            const snackbar = document.createElement('div');
            const bgColor = type === 'success' ? '#1a73e8' : type === 'error' ? '#ea4335' : '#323232';

            snackbar.style.cssText = `
                position: fixed;
                bottom: 24px;
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                background: ${bgColor};
                color: white;
                padding: 16px 24px;
                border-radius: 4px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 4000;
                font-size: 14px;
                font-weight: 500;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                max-width: 400px;
            `;
            snackbar.textContent = message;

            document.body.appendChild(snackbar);

            // Slide in
            setTimeout(() => {
                snackbar.style.transform = 'translateX(-50%) translateY(0)';
            }, 10);

            // Slide out and remove
            setTimeout(() => {
                snackbar.style.transform = 'translateX(-50%) translateY(100px)';
                setTimeout(() => snackbar.remove(), 300);
            }, 4000);
        }

        async function viewCourseModules(courseId, courseName) {
            currentCourseId = courseId;
            document.getElementById('viewCourseTitle').textContent = courseName;
            document.getElementById('viewCourseSubtitle').textContent = `Manage modules for this course`;
            document.getElementById('viewCourseId').value = courseId;
            document.getElementById('viewCourseModal').classList.add('active');

            // Load modules for this course
            await loadCourseModules(courseId);
        }

        function closeViewCourseModal() {
            document.getElementById('viewCourseModal').classList.remove('active');
            currentCourseId = null;
        }

        async function loadCourseModules(courseId) {
            try {
                const response = await fetch(`${API_BASE}/portal/courses/${courseId}/modules`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load course modules');

                const result = await response.json();
                const modules = result.data || [];

                const modulesList = document.getElementById('courseModulesList');

                if (modules.length === 0) {
                    modulesList.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">No modules yet. Click "+ Add Module" to create your first module.</div>';
                    return;
                }

                modulesList.innerHTML = modules.map(module => `
                    <div style="border:2px solid #e0e0e0; border-radius:12px; padding:25px; background:linear-gradient(to bottom, #ffffff 0%, #f9fafb 100%); margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                        <div style="display:flex; flex-direction:column;">
                            <!-- Module Header -->
                            <div style="border-bottom:2px dashed #ddd; padding-bottom:15px; margin-bottom:15px;">
                                <div style="font-size:12px; color:#0f6cbf; font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Module ${module.sequence_order}</div>
                                <div style="font-size:22px; font-weight:700; color:#333; margin-bottom:10px; line-height:1.3;">${module.module_name}</div>
                                <div style="font-size:14px; color:#666; line-height:1.6;">${module.description || 'No description available'}</div>
                            </div>

                            <!-- Status Badge -->
                            <div style="margin-bottom:15px;">
                                <span style="display:inline-block; background:#d4edda; color:#155724; padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600;">
                                    ‚úÖ Great! You've started learning!
                                </span>
                            </div>

                            <!-- What You'll Learn Section -->
                            <div style="background:#f0f7ff; border-left:4px solid #667eea; padding:15px; border-radius:6px; margin-bottom:15px;">
                                <div style="font-size:14px; font-weight:700; color:#333; margin-bottom:10px;">üìö What You'll Learn:</div>
                                <div style="font-size:13px; color:#555; line-height:1.8; padding-left:20px;">
                                    Learn key concepts and practical skills<br>
                                    in <strong>${module.module_name}</strong>
                                </div>
                            </div>

                            <!-- Content Stats -->
                            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:15px;">
                                <div style="text-align:center; background:white; padding:12px; border-radius:8px; border:1px solid #e0e0e0;">
                                    <div style="font-size:20px; font-weight:700; color:#0f6cbf;" id="content_files_${module.id}">-</div>
                                    <div style="font-size:10px; color:#666; margin-top:4px; text-transform:uppercase; letter-spacing:0.5px;">Files</div>
                                </div>
                                <div style="text-align:center; background:white; padding:12px; border-radius:8px; border:1px solid #e0e0e0;">
                                    <div style="font-size:20px; font-weight:700; color:#667eea;" id="content_chunks_${module.id}">-</div>
                                    <div style="font-size:10px; color:#666; margin-top:4px; text-transform:uppercase; letter-spacing:0.5px;">Chunks</div>
                                </div>
                                <div style="text-align:center; background:white; padding:12px; border-radius:8px; border:1px solid #e0e0e0;">
                                    <div style="font-size:20px; font-weight:700; color:#28a745;" id="graph_nodes_${module.id}">-</div>
                                    <div style="font-size:10px; color:#666; margin-top:4px; text-transform:uppercase; letter-spacing:0.5px;">Nodes</div>
                                </div>
                                <div style="text-align:center; background:white; padding:12px; border-radius:8px; border:1px solid #e0e0e0;">
                                    <div style="font-size:20px; font-weight:700; color:#f98012;" id="quiz_count_${module.id}">-</div>
                                    <div style="font-size:10px; color:#666; margin-top:4px; text-transform:uppercase; letter-spacing:0.5px;">Questions</div>
                                </div>
                            </div>

                            <!-- Ask Me Anything Section -->
                            <div style="background:#fff9e6; border-left:4px solid #f98012; padding:15px; border-radius:6px; margin-bottom:15px;">
                                <div style="font-size:14px; font-weight:700; color:#333; margin-bottom:10px;">üí¨ Ask Me Anything!</div>
                                <div style="font-size:13px; color:#666; line-height:1.8; padding-left:5px;">
                                    <div style="margin-bottom:5px; color:#555;">Examples:</div>
                                    <div style="padding-left:15px;">
                                        ‚Ä¢ "What is ${module.module_name.toLowerCase()}?"<br>
                                        ‚Ä¢ "Give me key concepts"<br>
                                        ‚Ä¢ "Show me examples"
                                    </div>
                                </div>
                            </div>

                            <!-- Uploaded Files Section -->
                            <div id="files_section_${module.id}" style="background:#f9fafb; border:1px solid #e0e0e0; border-radius:8px; padding:15px; margin-bottom:15px; display:none;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                    <div style="font-size:14px; font-weight:700; color:#333;">üìé Uploaded Files</div>
                                    <div style="font-size:12px; color:#666;" id="files_count_${module.id}">0 files</div>
                                </div>
                                <div id="files_list_${module.id}" style="display:flex; flex-direction:column; gap:8px;">
                                    <!-- File list will be populated here -->
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display:flex; gap:10px; border-top:2px dashed #ddd; padding-top:15px;">
                                <button class="btn-primary-moodle" onclick="openUploadModal(${module.id}, '${module.module_name.replace(/'/g, "\\'")}')">üì§ Upload Content</button>
                                <button class="btn-primary-moodle" onclick="openQuizUploadModal(${module.id}, '${module.module_name.replace(/'/g, "\\'")}')">üìù Upload Quiz</button>
                                <button class="btn-moodle" onclick="openChatModal(${module.id}, '${module.module_name.replace(/'/g, "\\'")}')">üí¨ AI Assistant</button>
                                <button class="btn-moodle" onclick="toggleFilesSection(${module.id})" id="toggle_files_${module.id}">üëÅÔ∏è View Files</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Load stats for each module
                modules.forEach(m => loadModuleStats(m.id));

            } catch (error) {
                console.error('Error loading course modules:', error);
                document.getElementById('courseModulesList').innerHTML = '<div style="text-align:center; padding:40px; color:#d32f2f;">Error loading modules</div>';
            }
        }

        // Module Modal Functions
        function openAddModuleModalForCourse() {
            console.log('Opening add module modal...');
            const courseId = document.getElementById('viewCourseId').value;
            console.log('Course ID:', courseId);

            if (!courseId) {
                alert('No course selected');
                return;
            }

            document.getElementById('moduleCourseId').value = courseId;
            document.getElementById('addModuleModal').classList.add('active');

            // Clear fields
            document.getElementById('moduleName').value = '';
            document.getElementById('moduleDescription').value = '';
            document.getElementById('moduleSequence').value = '1';

            console.log('Add module modal opened');
        }

        function closeAddModuleModal() {
            document.getElementById('addModuleModal').classList.remove('active');
        }

        async function createModule() {
            const courseId = document.getElementById('moduleCourseId').value;
            const name = document.getElementById('moduleName').value.trim();
            const description = document.getElementById('moduleDescription').value.trim();
            const sequence = parseInt(document.getElementById('moduleSequence').value);

            if (!name) {
                alert('Module name is required');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/portal/courses/${courseId}/modules`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        module_name: name,
                        description: description,
                        sequence_order: sequence
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Module created successfully!');
                    closeAddModuleModal();
                    loadCourseModules(courseId);
                } else {
                    alert(result.error || 'Failed to create module');
                }
            } catch (error) {
                console.error('Error creating module:', error);
                alert('Error creating module');
            }
        }

        /**
         * Load module statistics: content files, RAG chunks, Neo4j nodes, quiz questions
         */
        async function loadModuleStats(moduleId) {
            try {
                // Load content stats (files + chunks)
                const contentResponse = await fetch(`${API_BASE}/modules/${moduleId}/content`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (contentResponse.ok) {
                    const contentResult = await contentResponse.json();
                    const content = contentResult.data || [];
                    const totalChunks = content.reduce((sum, item) => sum + (item.chunk_count || 0), 0);

                    document.getElementById(`content_files_${moduleId}`).textContent = content.length;
                    document.getElementById(`content_chunks_${moduleId}`).textContent = totalChunks;

                    // Update files count and populate file list
                    const filesCountElem = document.getElementById(`files_count_${moduleId}`);
                    const filesListElem = document.getElementById(`files_list_${moduleId}`);

                    if (filesCountElem) {
                        filesCountElem.textContent = `${content.length} file${content.length !== 1 ? 's' : ''}`;
                    }

                    if (filesListElem && content.length > 0) {
                        filesListElem.innerHTML = content.map(file => `
                            <div style="background:white; border:1px solid #ddd; border-radius:6px; padding:12px; display:flex; justify-content:space-between; align-items:center; gap:10px;">
                                <div style="flex:1;">
                                    <div style="font-size:13px; font-weight:600; color:#333; margin-bottom:4px;">üìÑ ${file.original_name}</div>
                                    <div style="font-size:11px; color:#666;">
                                        ${file.chunk_count || 0} chunks ‚Ä¢
                                        Uploaded ${new Date(file.uploaded_at).toLocaleDateString()}
                                        ${file.uploaded_by_name ? `by ${file.uploaded_by_name}` : ''}
                                    </div>
                                </div>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <span style="display:inline-block; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; ${file.processed ? 'background:#d1fae5; color:#065f46;' : 'background:#fef3c7; color:#92400e;'}">
                                        ${file.processed ? '‚úÖ Processed' : '‚è≥ Processing'}
                                    </span>
                                    <button onclick="deleteModuleFile(${moduleId}, ${file.id}, '${file.original_name.replace(/'/g, "\\'")}')"
                                            style="background:#ef4444; color:white; border:none; border-radius:4px; padding:6px 12px; font-size:11px; cursor:pointer; font-weight:600;"
                                            onmouseover="this.style.background='#dc2626'"
                                            onmouseout="this.style.background='#ef4444'">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    } else if (filesListElem) {
                        filesListElem.innerHTML = '<div style="text-align:center; padding:20px; color:#999; font-size:13px;">No files uploaded yet</div>';
                    }
                } else {
                    document.getElementById(`content_files_${moduleId}`).textContent = '0';
                    document.getElementById(`content_chunks_${moduleId}`).textContent = '0';

                    const filesCountElem = document.getElementById(`files_count_${moduleId}`);
                    const filesListElem = document.getElementById(`files_list_${moduleId}`);

                    if (filesCountElem) filesCountElem.textContent = '0 files';
                    if (filesListElem) filesListElem.innerHTML = '<div style="text-align:center; padding:20px; color:#999; font-size:13px;">No files uploaded yet</div>';
                }

                // Load Neo4j graph nodes count
                const graphResponse = await fetch(`${API_BASE}/modules/${moduleId}/graph-stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (graphResponse.ok) {
                    const graphResult = await graphResponse.json();
                    document.getElementById(`graph_nodes_${moduleId}`).textContent = graphResult.data?.nodeCount || 0;
                } else {
                    document.getElementById(`graph_nodes_${moduleId}`).textContent = '0';
                }

                // Load quiz questions count
                const quizResponse = await fetch(`${API_BASE}/modules/${moduleId}/quiz`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (quizResponse.ok) {
                    const quizResult = await quizResponse.json();
                    const questions = quizResult.data || [];
                    document.getElementById(`quiz_count_${moduleId}`).textContent = questions.length;
                } else {
                    document.getElementById(`quiz_count_${moduleId}`).textContent = '0';
                }

            } catch (error) {
                console.error(`Error loading stats for module ${moduleId}:`, error);
                // Set defaults on error
                document.getElementById(`content_files_${moduleId}`).textContent = '0';
                document.getElementById(`content_chunks_${moduleId}`).textContent = '0';
                document.getElementById(`graph_nodes_${moduleId}`).textContent = '0';
                document.getElementById(`quiz_count_${moduleId}`).textContent = '0';
            }
        }

        /**
         * Test quiz for a module (opens quiz in chat window)
         */
        async function testModuleQuiz(moduleId) {
            try {
                const response = await fetch(`${API_BASE}/modules/${moduleId}/quiz`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    alert('No quiz available for this module');
                    return;
                }

                const result = await response.json();
                const questions = result.data || [];

                if (questions.length === 0) {
                    alert('No quiz questions found. Please generate quiz first.');
                    return;
                }

                // Open chat modal and display quiz
                openChatModal(moduleId, `Quiz - Module ${moduleId}`);

                // Add quiz questions to chat
                const messagesArea = document.getElementById('chatMessagesArea');
                messagesArea.innerHTML = `
                    <div class="chat-msg">
                        <div class="chat-msg-avatar">AI</div>
                        <div class="chat-msg-bubble">
                            <div class="chat-msg-text">
                                <strong>Quiz Ready!</strong><br>
                                ${questions.length} questions available.<br><br>
                                Type "start quiz" to begin, or ask me any questions about the module content.
                            </div>
                            <div class="chat-msg-time">${formatTime()}</div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading quiz:', error);
                alert('Error loading quiz');
            }
        }

        /**
         * Toggle files section visibility for a module
         */
        function toggleFilesSection(moduleId) {
            const filesSection = document.getElementById(`files_section_${moduleId}`);
            const toggleBtn = document.getElementById(`toggle_files_${moduleId}`);

            if (filesSection && toggleBtn) {
                const isHidden = filesSection.style.display === 'none';

                if (isHidden) {
                    filesSection.style.display = 'block';
                    toggleBtn.textContent = 'üëÅÔ∏è Hide Files';
                } else {
                    filesSection.style.display = 'none';
                    toggleBtn.textContent = 'üëÅÔ∏è View Files';
                }
            }
        }

        /**
         * Delete a file from a module
         */
        async function deleteModuleFile(moduleId, fileId, fileName) {
            if (!confirm(`Are you sure you want to delete "${fileName}"?\n\nThis will remove:\n‚Ä¢ The file from storage\n‚Ä¢ All database records\n‚Ä¢ All vector embeddings from ChromaDB\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/content/${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(`‚úÖ File "${fileName}" deleted successfully!`);

                    // Reload the module stats to update the file list
                    await loadModuleStats(moduleId);

                    console.log('File deleted:', result);
                } else {
                    alert(`‚ùå Failed to delete file: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert(`‚ùå Error deleting file: ${error.message}`);
            }
        }
    </script>
</body>
</html>
